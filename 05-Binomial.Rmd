# Khảo sát kết cục là tỷ lệ: Hồi quy Binomial

## Giới thiệu

...

## Bối cảnh của thí nghiệm

...

## Công cụ cần thiết cho quy trình

+ Thư viện dplyr trong hệ sinh thái tidyverse[@tidyverse] để thao tác dữ liệu và thống kê mô tả

+ Thư viện ggplot2, ggrides[@ggridges], tidybayes và ggdist để vẽ một số biểu đồ thống kê;

+ Thư viện gamlss[@gamlss1] để dựng mô hình GLM với phân phối Binomial

+ Thư viện marginaleffects[@marginal] để ước tính OR, RR và suy diễn thống kê từ kết quả mô hình.

```{r}
library(tidyverse)
library(ggridges)

library(gamlss)
library(marginaleffects)

library(tidybayes)
library(ggdist)
```

## Chuẩn bị dữ liệu

...

```{r}
df = read.csv('Dual_trigger.csv', sep = ';', 
              dec = ',', 
              fileEncoding = 'UTF-8-BOM')%>%na.omit()

df$Trigger = factor(df$Trigger)
df$p1 = df$blast/df$oocytes

df%>%head()%>%knitr::kable()
```

## Kế hoạch phân tích

...

## Thống kê mô tả

...

```{r}
df%>%group_by(Trigger)%>%
  summarize(n = n(),
            mean = mean(p1),
            SD = sd(p1),
            p5 = quantile(p1, 0.05),
            p95 = quantile(p1, 0.95),
            )%>%knitr::kable(digits = 3)
```
...

```{r}
pals = c("d" = "#fc035e", 
         "h" = "#b814ff", 
         "a" = "#fcb103")


df %>% ggplot(aes(x = blast, 
                      y = Trigger, 
                      fill= Trigger)) + 
  geom_density_ridges(stat = "binline", 
                      scale = 1, 
                      bins = 50,
                      alpha = 0.7,
                      draw_baseline = FALSE) +
  labs(x="Number of Blastocytes", y = "Trigger type") + 
  scale_fill_manual(values = pals, name = "Trigger") +
  scale_x_continuous(breaks = seq(0,30,5))+
  coord_flip() +
  theme_bw(10) +
  geom_vline(xintercept = median(df$blast),
             linetype=2,
             col="blue")+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  theme(axis.text = element_text(size = 10, color = "black"),
        axis.title = element_text(size = 10, color = "black"))
```

...

```{r}
df %>% ggplot(aes(y = p1, 
                      x = Trigger, 
                      fill= Trigger)) + 
  geom_boxplot(alpha = 0.7) +
  labs(y="Blastocyte formation rate", x = "Trigger type") + 
  scale_fill_manual(values = pals, name = "Trigger") +
  scale_y_continuous(breaks = seq(0,1,0.2))+
  coord_flip() +
  theme_bw(10) +
  geom_vline(xintercept = median(df$p1),
             linetype=2,
             col="blue")+
  theme(axis.text = element_text(size = 10, color = "black"),
        axis.title = element_text(size = 10, color = "black"))
```

...

## Dựng mô hình hồi quy GLM Binomial

...

```{r}
bi_mod = gamlss(cbind(blast, oocytes-blast) ~ 
               Trigger * (Age + AFC),
             data = df,
             family = BI(mu.link = "logit"),
             trace = F)

summary(bi_mod)
```
...

```{r}
plogis(-1.0593442)
```

...

```{r}
plogis(-1.0593442 + 0.3033475)
```

...

## Suy diễn thống kê

...

```{r}
dif_p = avg_comparisons(
  bi_mod,
  what = "mu",
  variables = list(Trigger = 'pairwise'))%>%
  dplyr::select(-c(1,7))

dif_p %>% knitr::kable(digits = 3)
```

...

```{r}
or = avg_comparisons(
  bi_mod,
  what = "mu",
  variables = list(Trigger = 'pairwise'),
  transform_pre = "lnoravg",
  transform_post = "exp")%>%
  dplyr::select(-c(1))

# Alternative in latest version:

or = avg_comparisons(
  bi_mod,
  what = "mu",
  variables = list(Trigger = 'pairwise'),
  comparison = "lnoravg",
  transform = "exp")%>%
  dplyr::select(-c(1))

or %>% mutate(contrast = 'OR')%>%
  knitr::kable(digits = 3)
```

...

```{r}
rr = avg_comparisons(
  bi_mod,
  what = "mu",
  variables = list(Trigger = 'pairwise'),
  transform_pre = "lnratioavg",
  transform_post = exp)%>%
  dplyr::select(-c(1))

# Alternative for latest version

rr = avg_comparisons(
  bi_mod,
  what = "mu",
  variables = list(Trigger = 'pairwise'),
  comparison = "lnratioavg",
  transform = exp)%>%
  dplyr::select(-c(1))

rr %>%mutate(contrast = 'RR')%>%
  knitr::kable(digits = 3)
```

...

```{r}
or = avg_comparisons(
  bi_mod,
  what = "mu",
  by = "AFC",
  variables = list(Trigger = 'pairwise'),
  newdata = datagrid(AFC = c(2,5,10,20),
                     grid_type = 'counterfactual'),
  transform_pre = "lnoravg",
  transform_post = "exp")

# Alternative for latest version

or = avg_comparisons(
  bi_mod,
  what = "mu",
  by = "AFC",
  variables = list(Trigger = 'pairwise'),
  newdata = datagrid(AFC = c(2,5,10,20),
                     grid_type = 'counterfactual'),
  comparison = "lnoravg",
  transform = "exp")

or %>% mutate(contrast = 'OR')%>%
  knitr::kable(digits = 3)
```

...

```{r}
preds = predictions(bi_mod, 
                    what = "mu", 
                    newdata = datagrid(Trigger = c('d','a','h'),
                                       grid_type = "counterfactual"),
                    new_data = df)

preds%>%ggplot()+
  stat_halfeye(alpha = 0.4, 
               aes(x = Trigger, 
                   y = estimate,
                   fill = Trigger),
               .width = c(0.75, 0.95),
               point_interval = 'median_qi',
               show.legend = T)+
  stat_lineribbon(aes(y = estimate, 
                      x = Trigger), 
                  fill = 'gold',
                  .width = c(.95, .75, .50), 
                  alpha = 1/8,
                  show.legend = F) +
  labs(y="Rate of blastocytes", 
       x = "Trigger") + 
  scale_fill_manual(values = pals, 
                    name = "Trigger")+
  scale_y_continuous(breaks = c(seq(0,0.4,0.05)))+
  theme_bw()
```

...

```{r}
preds = predictions(model = bi_mod,
                    what = "mu",
                    newdata = datagrid(AFC = c(1,5,10,15,20,30),
                                       grid_type = "counterfactual"))

preds%>%ggplot()+
  stat_halfeye(alpha = 0.4, 
               aes(x = Trigger, 
                   y = estimate,
                   fill = Trigger),
               .width = c(0.75, 0.95),
               point_interval = 'median_qi',
               show.legend = T)+
  stat_lineribbon(aes(y = estimate, x = Trigger), 
                  fill = 'gold',
                  .width = c(.95, .75, .50), 
                  alpha = 1/8,
                  show.legend = F) +
  labs(y="Rate of blastocytes", x = "Trigger") + 
  scale_fill_manual(values = pals, name = "Trigger")+
  facet_wrap(~AFC, scales = "free")+
  theme_bw()
```

**Diễn giải kết quả của phân tích** : 

...

## Thông điệp rút gọn làm hành trang

...

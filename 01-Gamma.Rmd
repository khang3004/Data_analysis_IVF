# Khảo sát biến số liên tục: Mô hình hồi quy Gamma

## Bối cảnh của thí nghiệm

Thí dụ minh họa sử dụng dataset "Five_protocols.csv" từ một nghiên cứu có thực trên 1005 phụ nữ được thực hiện thụ tinh nhân tạo. Mục tiêu đặt ra là khảo sát giá trị hormone LH ở ngày trigger (biến LH) giữa 5 loại phác đồ kích thích buồng trứng (biến Protocol), gồm: 

+ Mild = mild stimulation sử dụng Letrozole, 
+ GnRH_ant = Phác đồ đối vận GnRH, 
+ Fol_long = Follicular long acting, 
+ PPOS: Progestin-Primed Ovarian Stimulation, 
+ Lut_short = Lutean phase short acting.

## Công cụ cần thiết

Quy trình phân tích cần những công cụ sau đây:

+ Hệ sinh thái tidyverse [@tidyverse]: với thư viện ggplot2 cho đồ họa thống kê và dplyr để thao tác dữ liệu
+ Thư viện ggridges [@ggridges]: để vẽ biểu đổ mật độ phân phối riêng cho từng phân nhóm (ggplot2 cơ bản không hỗ trợ loại biểu đồ này).
+ Thư viện fitdistrplus [@fitdistrplus] cho phép kiểm tra tính phù hợp giữa dữ liệu thực nghiệm và một quy luật phân phối xác suất lý thuyết, như Gaussian hoặc Gamma.
+ Thư viện gamlss [@gamlss1]: cho phép khớp các mô hình hồi quy cho nhiều họ phân phối khác nhau, bao gồm Gamma.
+ Thư viện broom [@broom]: cho phép thao tác trên kết quả mô hình hồi quy gamlss.
+ Thư viện marginaleffects [@marginal]: dùng cho phân tích hậu kiểm (post-hoc analysis) trên kết quả mô hình hồi quy gamlss

```{r,message = FALSE,warning=FALSE}
# Thao tác dữ liệu và đồ họa
library(tidyverse)
library(ggridges)

# Kiểm tra quy luật phân phối
library(fitdistrplus)

# Mô hình GLM
library(broom)
library(gamlss)

library(marginaleffects)
```

## Chuẩn bị dữ liệu

```{r,message = FALSE,warning=FALSE}
df <- read.csv('Five_protocols.csv', 
               sep = ';', 
               dec= '.', 
               fileEncoding = 'UTF-8-BOM')%>%na.omit()

df$Protocol = as.factor(df$Protocol)

df%>%sample_frac(0.1)%>%head()%>%knitr::kable()
```

```{r}
levels(df$Protocol)
```
## Phân tích mô tả

```{r}
df%>% 
  group_by(Protocol)%>%
  summarize(n = n(),
            mean = mean(LH),
            sd = sd(LH),
            median = median(LH),
            p5 = quantile(LH, 0.05),
            p95 = quantile(LH, 0.95),
            min= min(LH),
            max = max(LH),
            )%>%
    arrange(mean)%>%
    knitr::kable(digits = 3)
```

```{r,message = FALSE,warning=FALSE}
med_df = df %>% 
  group_by(Protocol)%>%
  summarize_at('LH', mean)

ggplot()+
  geom_density_ridges(data = df,
                      aes(y = reorder(Protocol,LH), 
                          x = LH,
                          fill = reorder(Protocol,LH)),
                      scale = 0.8,
                      alpha = 0.5,
                      show.legend = F)+
  geom_line(data = med_df,
            aes(y = reorder(Protocol,LH), x = LH, group = 1),
            color = 'black',
            size = 1,
            alpha = 0.5)+
  geom_point(data = med_df,
            aes(y = reorder(Protocol,LH), x = LH),
            color = 'black',
            size = 2.5,
            alpha = 0.9)+
  coord_flip()+
  scale_fill_manual(values = c("#b5d914",
                               "#f5bf0c",
                               "#f5940c",
                               "#f50c84",
                               "#a00cf5"))+
  scale_x_continuous(limits = c(-0.5,40), 
                     breaks = seq(0,40,by = 5))+
  labs(x = 'LH level (mIU/mL)', y = 'Protocols')+
  theme_bw(10)
```

```{r}
ggplot()+
  geom_boxplot(data = df,
                      aes(x = reorder(Protocol,LH), 
                          y = LH,
                          fill = reorder(Protocol,LH)),
                      alpha = 0.5,
                      show.legend = F)+
  geom_point(data = med_df,
            aes(x = reorder(Protocol,LH), y = LH),
            color = 'black',
            shape = 18,
            size = 5,
            alpha = 0.9)+
  scale_fill_manual(values = c("#b5d914",
                               "#f5bf0c",
                               "#f5940c",
                               "#f50c84",
                               "#a00cf5"))+
  scale_y_continuous(limits = c(-0.5,40), 
                     breaks = seq(0,40,by = 5))+
  labs(y = 'LH level (mIU/mL)', x = 'Protocols')+
  coord_flip()+
  theme_bw(10)
```

## Biện luận về tính phù hợp của phân phối Gamma

```{r,message = FALSE,warning=FALSE}
fit_gam = fitdist(df$LH, 'gamma', optim.method = 'BFGS')
fit_gauss = fitdist(df$LH, 'norm', optim.method = 'BFGS')

denscomp(list(fit_gauss, fit_gam), 
         legendtext = c("Gaussian", "Gamma"),
         plotstyle = 'ggplot',
         fitcol = c('#03a9fc','#fc036f'),
         dempcol = c('grey'),
         fitlty = 1,
         fitlwd = 1)+
  labs(x = 'LH on trigger day (mUI/mL)')+ 
  theme_bw()
```

```{r,message = FALSE,warning=FALSE}
cdfcomp(list(fit_gauss, fit_gam), 
        legendtext = c("Gaussian", "Gamma"),
        plotstyle = 'ggplot',
        fitcol = c('#03a9fc','#fc036f'),
        fitlty = 1,
        datacol = 'grey')+
  labs(x = 'LH on trigger day (mUI/mL)')+ 
  theme_bw()
```
## Dựng mô hình hồi quy với phân phối Gamma

```{r, results='hide'}
# Mô hình chỉ có intercept

m0 = gamlss(formula = LH ~ 1,
             data=df,
             family = GA,
             trace=F,
             parallel="multicore",
             ncpus = nC)
```

```{r}
summary(m0)
```

```{r}
mean(df$LH)
```

```{r, results='hide'}
# Mô hình ANOVA 1 biến

m1 = gamlss(formula = LH ~ Protocol,
            sigma.formula = ~ Protocol,
            data=df,
            family = GA,
            trace=F,
            parallel="multicore",
            ncpus = nC)
```

```{r}
summary(m1)
```

```{r}
df%>% 
  group_by(Protocol)%>%
  summarize('mean' = mean(LH)) %>% knitr::kable()
```

```{r}
LR.test(m0,m1)
```

```{r}
pw_comp = avg_comparisons(m1,
                          what = 'mu',
                variables = list(Protocol = 'pairwise'))

pw_comp$adj_p = p.adjust(pw_comp$p.value, 
                         method = 'bonferroni')

pw_comp %>%
  dplyr::select(-c(1,2,6,7))%>%
  knitr::kable(digits = 3)
```

```{r}
m1%>%augment()%>%mutate(UL= .fitted +.se.fit*1.96,
                     LL=.fitted-.se.fit*1.96)%>%
  group_by(Protocol)%>%
  summarize_at('.fitted', median) -> m1_sum

augment(m1)%>%mutate(UL= .fitted +.se.fit*1.96,
                     LL=.fitted-.se.fit*1.96)%>%
  ggplot()+
  geom_jitter(aes(y = reorder(Protocol,LH), 
                  x = LH,
                  col = reorder(Protocol,LH)),
              scale = 0.8,
              alpha = 0.3,
              width = 0.01,
              show.legend = F)+
  geom_density_ridges(aes(y = reorder(Protocol,LH), 
                          x = LH,
                          fill = reorder(Protocol,LH)),
                      scale = 0.8,
                      alpha = 0.3,
                      show.legend = F)+
  geom_errorbar(aes(y=reorder(Protocol,exp(.fitted)), 
                    xmin=exp(LL), 
                    xmax=exp(UL)),
                width=0.1,
                size=1) + 
  geom_line(data = m1_sum,
            aes(y=reorder(Protocol,exp(.fitted)), 
                x=exp(.fitted),
                group = 1))+
  geom_point(aes(y=reorder(Protocol,exp(.fitted)), 
                 x=exp(.fitted)), 
             size=3)+
  scale_fill_manual(values = c("#b5d914",
                               "#f5bf0c",
                               "#f5940c",
                               "#f50c84",
                               "#a00cf5"))+
  
  scale_color_manual(values = c("#b5d914",
                               "#f5bf0c",
                               "#f5940c",
                               "#f50c84",
                               "#a00cf5"))+
  scale_x_continuous(breaks = seq(0,40,by = 5))+
  labs(x = 'LH level on trigger day (mIU/mL)', y = 'Protocols')+
  coord_flip()+
  theme_bw()  
```

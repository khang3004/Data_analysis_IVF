# Khảo sát biến số liên tục: Mô hình hồi quy Gamma

## Giới thiệu

...

## Bối cảnh của thí nghiệm

...

## Công cụ cần thiết

Quy trình phân tích cần những công cụ sau đây:

+ Hệ sinh thái tidyverse [@tidyverse]: với thư viện ggplot2 cho đồ họa thống kê và dplyr để thao tác dữ liệu

+ Thư viện ggridges [@ggridges]: để vẽ biểu đổ mật độ phân phối riêng cho từng phân nhóm (ggplot2 cơ bản không hỗ trợ loại biểu đồ này).

+ Thư viện fitdistrplus [@fitdistrplus] cho phép kiểm tra tính phù hợp giữa dữ liệu thực nghiệm và một quy luật phân phối xác suất lý thuyết, như Gaussian hoặc Gamma.

+ Thư viện gamlss [@gamlss1]: cho phép khớp các mô hình hồi quy cho nhiều họ phân phối khác nhau, bao gồm Gamma.

+ Thư viện broom [@broom]: cho phép thao tác trên kết quả mô hình hồi quy gamlss.

+ Thư viện marginaleffects [@marginal]: dùng cho phân tích hậu kiểm (post-hoc analysis) trên kết quả mô hình hồi quy gamlss

```{r,message = T, warning=T}
# Thao tác dữ liệu và đồ họa
library(tidyverse)
library(ggridges)

# Kiểm tra quy luật phân phối
library(fitdistrplus)

# Mô hình GLM
library(broom)
library(gamlss)

library(marginaleffects)
```

## Chuẩn bị dữ liệu

...

Xem cấu trúc dữ liệu

```{r,message = T,warning=T}
df <- read.csv('Five_protocols.csv', 
               sep = ';', 
               dec= '.', 
               fileEncoding = 'UTF-8-BOM')%>%na.omit()

df$Protocol = as.factor(df$Protocol)

df%>%sample_frac(0.1)%>%
  head()%>%
  knitr::kable(digits = 2)
```

Một cách mặc định, biến rời rạc loại factor sẽ được phân cấp theo thứ tự alphabet, mỗi bậc giá trị sẽ tương ứng với số thứ tự. Trong trường hợp này, thứ tự các loại protocol là:

1 = Fol_long (sẽ được xem là nhóm tham chiếu khi phân tích hồi quy)

2 = GnRH_ant

3 = Lut_short

4 = Mild

5 = PPOS

```{r}
levels(df$Protocol)
```

## Kế hoạch phân tích

...

## Phân tích mô tả

...

**1) Dựng bảng thống kê mô tả**

...

```{r}
df%>% 
  group_by(Protocol)%>%
  summarize(n = n(),
            mean = mean(LH, na.rm = T),
            sd = sd(LH, na.rm = T),
            median = median(LH, na.rm = T),
            p5 = quantile(LH, 0.05, na.rm = T),
            p95 = quantile(LH, 0.95, na.rm = T),
            min= min(LH, na.rm = T),
            max = max(LH, na.rm = T),
            )%>%
    arrange(mean)%>%
    knitr::kable(digits = 3)
```

...

**2) So sánh trực quan bằng biểu đồ**

...

```{r,message = T, warning=T}
med_df = df %>% 
  group_by(Protocol)%>%
  summarize_at('LH', mean)

pals = c("#b5d914",
         "#f5bf0c", 
         "#f5940c",
         "#f50c84", 
         "#a00cf5")

ggplot()+
  geom_density_ridges(data = df,
                      aes(y = reorder(Protocol,LH), 
                          x = LH,
                          fill = reorder(Protocol,LH)),
                      scale = 0.8,
                      alpha = 0.5,
                      show.legend = F)+
  geom_line(data = med_df,
            aes(y = reorder(Protocol,LH), x = LH, group = 1),
            color = 'black',
            linewidth = 1,
            alpha = 0.5)+
  geom_point(data = med_df,
            aes(y = reorder(Protocol,LH), x = LH),
            color = 'black',
            size = 2.5,
            alpha = 0.9)+
  coord_flip()+
  scale_fill_manual(values = pals)+
  scale_x_continuous(limits = c(-0.5,40), 
                     breaks = seq(0,42,by = 5))+
  labs(x = 'LH level (mIU/mL)', y = 'Protocols')+
  theme_bw(10)
```

...

```{r}
ggplot()+
  geom_boxplot(data = df,
                      aes(x = reorder(Protocol,LH), 
                          y = LH,
                          fill = reorder(Protocol,LH)),
                      alpha = 0.5,
                      show.legend = F)+
  geom_point(data = med_df,
            aes(x = reorder(Protocol,LH), y = LH),
            color = 'black',
            shape = 18,
            size = 5,
            alpha = 0.9)+
  scale_fill_manual(values = pals)+
  scale_y_continuous(limits = c(-0.5,40), 
                     breaks = seq(0,42,by = 5))+
  labs(y = 'LH level (mIU/mL)', x = 'Protocols')+
  coord_flip()+
  theme_bw(10)
```

## Biện luận về tính phù hợp của phân phối Gamma

...

```{r,message = FALSE,warning=FALSE}
fit_gam = fitdist(df$LH, 
                  'gamma', 
                  optim.method = 'BFGS')

fit_gauss = fitdist(df$LH, 
                    'norm', 
                    optim.method = 'BFGS')

denscomp(list(fit_gauss, fit_gam), 
         legendtext = c("Gaussian", "Gamma"),
         plotstyle = 'ggplot',
         fitcol = c('#03a9fc','#fc036f'),
         dempcol = c('grey'),
         fitlty = 1,
         fitlwd = 1)+
  labs(x = 'LH on trigger day (mUI/mL)')+ 
  theme_bw()
```

...

```{r,message = FALSE,warning=FALSE}
cdfcomp(list(fit_gauss, fit_gam), 
        legendtext = c("Gaussian", "Gamma"),
        plotstyle = 'ggplot',
        fitcol = c('#03a9fc','#fc036f'),
        fitlty = 1,
        datacol = 'grey')+
  labs(x = 'LH on trigger day (mUI/mL)')+ 
  theme_bw()
```

...

## Dựng mô hình hồi quy với phân phối Gamma

...

```{r, results='hide'}
# Mô hình chỉ có intercept

m0 = gamlss(formula = LH ~ 1,
             data=df,
             family = GA,
             trace=F,
             parallel="multicore",
             ncpus = nC)
```

...

```{r}
summary(m0)
```
...

```{r}
mean(df$LH)
```

...

```{r, results='hide'}
# Mô hình ANOVA 1 biến

m1 = gamlss(formula = LH ~ Protocol,
            sigma.formula = ~ Protocol,
            data=df,
            family = GA,
            trace=F,
            parallel="multicore",
            ncpus = nC)
```

...

```{r}
summary(m1)
```

...

```{r}
df%>% 
  group_by(Protocol)%>%
  summarize('mean' = mean(LH))%>% 
  knitr::kable(digits = 3)
```

...

## Suy diễn thống kê từ mô hình GLM-Gamma

...

```{r}
LR.test(m0,m1)
```

...

```{r}
pw_comp = avg_comparisons(m1,
                          what = 'mu',
                          newdata = df,
                variables = list(Protocol = 'pairwise'))

pw_comp$adj_p = p.adjust(pw_comp$p.value, 
                         method = 'bonferroni')

pw_comp %>%
  dplyr::select(-c(1,2,6,7))%>%
  knitr::kable(digits = 5)
```

...

```{r}
m1%>%augment()%>%mutate(UL= .fitted +.se.fit*1.96,
                     LL=.fitted-.se.fit*1.96)%>%
  group_by(Protocol)%>%
  summarize_at('.fitted', median) -> m1_sum

augment(m1)%>%mutate(UL= .fitted +.se.fit*1.96,
                     LL=.fitted-.se.fit*1.96)%>%
  ggplot()+
  geom_jitter(aes(y = reorder(Protocol,LH), 
                  x = LH,
                  col = reorder(Protocol,LH)),
              alpha = 0.3,
              width = 0.01,
              show.legend = F)+
  geom_density_ridges(aes(y = reorder(Protocol,LH), 
                          x = LH,
                          fill = reorder(Protocol,LH)),
                      scale = 0.8,
                      alpha = 0.3,
                      show.legend = F)+
  geom_errorbar(aes(y=reorder(Protocol,exp(.fitted)), 
                    xmin=exp(LL), 
                    xmax=exp(UL)),
                width=0.1,
                size=1) + 
  geom_line(data = m1_sum,
            aes(y=reorder(Protocol,exp(.fitted)), 
                x=exp(.fitted),
                group = 1))+
  geom_point(aes(y=reorder(Protocol,exp(.fitted)), 
                 x=exp(.fitted)), 
             size=3)+
  scale_fill_manual(values = pals)+
  
  scale_color_manual(values = pals)+
  scale_x_continuous(breaks = seq(0,50,by = 5))+
  labs(x = 'LH level on trigger day (mIU/mL)', y = 'Protocols')+
  coord_flip()+
  theme_bw()  
```

...

## Kết luận

...

## Thông điệp rút gọn làm hành trang

...

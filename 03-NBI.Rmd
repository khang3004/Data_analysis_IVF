# Khảo sát kết cục số đếm: Hồi quy Negative Binomial

## Công cụ cần thiết

Quy trình phân tích sẽ sử dụng các thư viện sau trong R:

+ Thư viện dplyr trong hệ sinh thái tidyverse[@tidyverse] để thao tác dữ liệu và thống kê mô tả
+ Thư viện fitdistrplus[@fitdistrplus] để đối chiếu 3 quy luật phân phối Gaussian, Poisson và NBI, nhằm chứng minh tính phù hợp hơn của phân phối NBI.
+ Thư viện ggplot2, ggrides[@ggridges], tidybayes[@tidybayes] và ggdist[@ggdist] để vẽ một số biểu đồ thống kê; thư viện patchwork để ghép các biểu đồ với nhau.
+ Thư viện gamlss[@gamlss1] để dựng mô hình GLM với phân phối NBI
+ Thư viện marginaleffects[@marginal] để ước tính avegrage marginal effect (AME) và suy diễn thống kê từ kết quả mô hình.
+ Thư viện broom[@broom] nhằm trích xuất dữ liệu kết quả ước lượng từ mô hình.

```{r}
library(tidyverse)
library(ggridges)
library(tidybayes)
library(ggdist)
library(patchwork)

library(fitdistrplus)

library(gamlss)
library(broom)

library(marginaleffects)
```

```{r,message = FALSE,warning=FALSE}
df = read.csv('POSEIDON_ART.csv',
              sep = ';',
              dec = ',',
              fileEncoding = "UTF-8-BOM")%>%
  dplyr::filter(POSEIDON>0)

df$POSEIDON= as.factor(df$POSEIDON)

df%>%dplyr::sample_frac(0.1)%>%head(6)%>%knitr::kable()
```

## Thống kê mô tả

```{r,message = FALSE,warning=FALSE}
tot = nrow(df)

df %>% 
  group_by(POSEIDON) %>% 
  summarize(n = n(),
            prop = 100*n/tot,
            mean = mean(Collected),
            sd = sd(Collected),
            median = median(Collected),
            p5 = quantile(Collected, 0.05),
            p95 = quantile(Collected, 0.95)
            ) %>% 
  knitr::kable(digits = 3)
```

```{r,message = FALSE,warning=FALSE}

pals = c("#ffc403","#ff7403","#ff0357","#9203ff")

P1 = df %>% ggplot(aes(x = Collected, 
                      y = POSEIDON, 
                      fill= POSEIDON)) + 
  geom_density_ridges(stat = "binline", 
                      scale = 2, 
                      bins = 50,
                      alpha = 0.7,
                      draw_baseline = FALSE,
                      show.legend = F) +
  labs(x="Number of retrieved oocytes", y = "POSEIDON groups") + 
  scale_fill_manual(values = pals, name = "POSEIDON") +
  scale_x_continuous(breaks = seq(0,80,5))+
  coord_flip() +
  theme_bw(9) +
  geom_vline(xintercept = median(df$Collected),
             linetype=2,
             col="blue")+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  theme(axis.text = element_text(size = 10, color = "black"),
        axis.title = element_text(size = 10, color = "black"))

P1
```

```{r}

pals_2 = c("#b5e617","#ffc403","#ff7403","#ff0357","#9203ff")

df2 = read.csv('POSEIDON_ART.csv',
              sep = ';',
              dec = ',',
              fileEncoding = "UTF-8-BOM")

df2$POSEIDON = factor(df2$POSEIDON)

df2%>%gather(c(AFC,Age,AMH), key = 'Parameter', value = "Value")%>%
  ggplot()+
  geom_jitter(aes(x = Value, 
                  y = Collected,
                  col = POSEIDON),
              alpha = 0.2,
              size = 1)+
  geom_smooth(aes(x = Value, 
                  y = Collected,
                  fill = POSEIDON, 
                  col = POSEIDON),
              alpha = 0.3,
              show.legend = T,
              method = 'glm')+
  scale_color_manual(values = pals_2)+
  scale_fill_manual(values = pals_2)+
  labs(y="Number of retrieved oocytes", x = "Value") + 
  theme_bw(10)+
  facet_wrap(~Parameter, scales = "free", ncol = 2)
```

## Biện luận về tính phù hợp của quy luật phân phối NBI

```{r}
fit_poisson = fitdist(df$Collected, 'pois', optim.method = 'BFGS')
fit_negbin = fitdist(df$Collected, 'nbinom', optim.method = 'BFGS')
fit_norm = fitdist(df$Collected, 'norm', optim.method = 'BFGS')

P1 = denscomp(list(fit_poisson, fit_negbin, fit_norm), 
         legendtext = c("Poisson", "Negative binomial","Gaussian"),
         plotstyle = 'ggplot',
         fitcol = c('#03a9fc','#fc036f','#32a852'),
         dempcol = c('grey'),
         fitlty = 1,
         fitlwd = 1)+
  theme_bw()

P2 = cdfcomp(list(fit_poisson, fit_negbin,fit_norm), 
        legendtext = c("Poisson", "Negative binomial","Gaussian"),
        plotstyle = 'ggplot',
        fitcol = c('#03a9fc','#fc036f','#32a852'),
        fitlty = 1,
        datacol = 'grey')

P2 / P1
```

## Phân tích hồi quy bằng mô hình GLM NBI

```{r,message = FALSE,warning=FALSE}
mod_1 = gamlss(data = df, 
               formula = Collected ~ POSEIDON, 
               sigma.formula =~ POSEIDON,
               family = NBI())
```
Kết quả của mô hình mod_1 như sau:

```{r}
summary(mod_1)
```

```{r}
df%>%group_by(POSEIDON) %>% summarize("Mean" = mean(Collected))%>%
  knitr::kable()
```

```{r,message = FALSE,warning=FALSE}
abs = avg_comparisons(mod_1, 
                what = 'mu',
                variables = list(POSEIDON = 'pairwise'))

abs$adj_p = p.adjust(abs$p.value, method = "bonferroni")

abs%>%dplyr::select(-c(2,6))%>%
  knitr::kable(digits = 3)
```

```{r,results='hide'}

augment(mod_1)%>%mutate(UL= .fitted +.se.fit*1.96,
                        LL=.fitted-.se.fit*1.96)%>%
  group_by(POSEIDON)%>%
  summarize_at('.fitted', median) -> m1_sum

augment(mod_1)%>%mutate(UL= .fitted +.se.fit*1.96,
                        LL=.fitted-.se.fit*1.96)%>%
  ggplot()+
  geom_jitter(aes(y = POSEIDON, 
                  x = Collected,
                  col = POSEIDON),
              alpha = 0.2,
              width = 0.01,
              height = 0.1,
              show.legend = F)+
  geom_density_ridges(aes(y = POSEIDON, 
                          x = Collected,
                          fill = POSEIDON),
                      stat = "binline", 
                      scale = 1, 
                      bins = 50,
                      alpha = 0.5,
                      draw_baseline = FALSE,
                      show.legend = F)+
  geom_errorbar(aes(y=POSEIDON, 
                    xmin=exp(LL), 
                    xmax=exp(UL)),
                width=0.2,
                size=1) + 
  geom_path(data = m1_sum,
            aes(y=POSEIDON, 
                x=exp(.fitted),
                group = 1))+
  geom_point(aes(y=POSEIDON, 
                 x=exp(.fitted)), 
             size=3)+
  labs(x="Number of retrieved oocytes", y = "POSEIDON groups") + 
  scale_fill_manual(values = pals) +
  scale_color_manual(values = pals) +
  scale_x_continuous(breaks = seq(0,60,5))+
  coord_flip()+
  theme_bw()  
```

```{r}
mod_2 = gamlss(data = df2, 
               formula = Collected ~ Age + AMH + AFC, 
               sigma.formula =~ Age + AMH + AFC,
               family = NBI())

summary(mod_2)
```

```{r}
abs = avg_comparisons(mod_2, 
                what = "mu")

abs%>%dplyr::select(-c(1,6))%>%
  knitr::kable(digits = 3)
```

```{r}
preds = predictions(model = mod_2,
                    what = "mu",
                    newdata = datagrid(Age = seq(20,40,5),
                                       grid_type = "counterfactual"))

preds%>%ggplot(aes(x = Age,
                   y = estimate)) +
  stat_lineribbon(aes(y = estimate), 
                  fill = "gold",
                  .width = c(.95, .75, .50), 
                  alpha = 1/5,
                  show.legend = F) +
  stat_dotsinterval(aes(fill = factor(Age)),
                    quantiles = 50,
                    alpha = 0.7, 
                    .width = c(0.75, 0.95),
                    point_interval = 'median_qi',
                    show.legend = F)+
  labs(y="Number of retrieved eggs", x = "Age") + 
  scale_y_continuous(limits = c(0,40), breaks = seq(0,40,5))+
  scale_x_continuous(limits = c(20,45), breaks = seq(20,40,5))+
  theme_bw(10)+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  theme(axis.text = element_text(size = 10, color = "black"),
        axis.title = element_text(size = 10, color = "black"))
```

```{r}
preds = predictions(model = mod_2,
                    what = "mu",
                    newdata = datagrid(AMH = seq(0,10,1),
                                       grid_type = "counterfactual"))

preds%>%ggplot(aes(x = AMH,
                   y = estimate)) +
  stat_lineribbon(aes(y = estimate), 
                  fill = "gold",
                  .width = c(.95, .75, .50), 
                  alpha = 1/5,
                  show.legend = F) +
  stat_dotsinterval(aes(fill = factor(AMH)),
                    quantiles = 50,
                    alpha = 0.5, 
                    .width = c(0.75, 0.95),
                    point_interval = 'median_qi',
                    show.legend = F)+
  labs(y="Number of retrieved eggs", x = "AMH") + 
  scale_y_continuous(limits = c(0,35), breaks = seq(0,35,5))+
  scale_x_continuous(limits = c(0,11), breaks = seq(0,10,1))+
  theme_bw(10)+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  theme(axis.text = element_text(size = 10, color = "black"),
        axis.title = element_text(size = 10, color = "black"))
```

```{r}
preds = predictions(model = mod_2,
                    what = "mu",
                    newdata = datagrid(AFC = seq(1,30,2.5),
                                       grid_type = "counterfactual"))

preds%>%ggplot(aes(x = AFC,
                   y = estimate)) +
  stat_lineribbon(aes(y = estimate), 
                  fill = "gold",
                  .width = c(.95, .75, .50), 
                  alpha = 1/5,
                  show.legend = F) +
  stat_dotsinterval(aes(fill = factor(AFC)),
                    quantiles = 50,
                    alpha = 0.7, 
                    .width = c(0.75, 0.95),
                    point_interval = 'median_qi',
                    show.legend = F)+
  labs(y="Number of retrieved eggs", x = "AFC") + 
  scale_y_continuous(limits = c(0,40), breaks = seq(0,40,5))+
  scale_x_continuous(limits = c(0,31), breaks = seq(0,30,5))+
  theme_bw(10)+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  theme(axis.text = element_text(size = 10, color = "black"),
        axis.title = element_text(size = 10, color = "black"))
```

```{r}
preds = predictions(model = mod_2,
                    what = "mu",
                    newdata = datagrid(AFC = seq(1,30,2.5),
                                       Age = c(25,30,35,40),
                                       grid_type = "counterfactual"))

preds%>%ggplot(aes(x = AFC,
                   y = estimate)) +
  stat_lineribbon(aes(y = estimate), 
                  fill = "gold",
                  .width = c(.95, .75, .50), 
                  alpha = 1/5,
                  size = 1,
                  show.legend = F) +
  stat_dotsinterval(aes(fill = factor(AFC)),
                    quantiles = 50,
                    alpha = 0.7, 
                    size = 1,
                    .width = c(0.75, 0.95),
                    point_interval = 'median_qi',
                    show.legend = F)+
  labs(y="Number of retrieved eggs", x = "AFC") + 
  scale_y_continuous(limits = c(0,40), breaks = seq(0,40,5))+
  scale_x_continuous(limits = c(0,31), breaks = seq(0,30,5))+
  theme_bw(10)+
  facet_wrap(~Age, scales = "free")+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  theme(axis.text = element_text(size = 10, color = "black"),
        axis.title = element_text(size = 10, color = "black"))
```

# Ứng dụng sơ đồ mạng định hướng không tuần hoàn (DAG)

```{r,message = FALSE,warning=FALSE}
library(tidyverse)
library(ggridges)

library(broom)
library(dagitty)
library(ggdag)

library(marginaleffects)

library(patchwork)
```

Đây là cấu trúc dữ liệu cho bài toán:

```{r,message = FALSE,warning=FALSE}
df <- read.csv('Letrozole_PCOS.csv', 
               sep = ';', dec= ',', 
               fileEncoding = 'UTF-8-BOM')%>%na.omit()

df$Method = factor(df$Method)
df$Inserm = factor(df$Inserm)
df$Type = factor(df$Type)
df$COS = factor(df$COS)
df$Transf = factor(df$Transf)
df$Stage = factor(df$Stage)

df%>%head()%>%knitr::kable()
```

## Mô tả đơn giản

```{r,message = FALSE,warning=FALSE}
df%>%group_by(Method)%>%
  summarize(n = n(),
            LiveBirth = sum(LBirth==1),
            Failure = sum(LBirth==0),
            p1 = mean(LBirth),
            p0 = 1- p1,
            )%>%knitr::kable()
```

## Sơ đồ nhân quả và mô hình DAG

Dựa vào suy luận và kiến thức sinh lý, y học lâm sàng, ta có thể đặt ra hệ thống giả thuyết như sau:

+ Loại can thiệp chuẩn bị nội mạc (Letrozole hay chu kì nhân tạo) là kết quả quyết định chủ quan của bệnh nhân và bác sĩ điều trị, ta giả định rằng nó có thể chịu ảnh hưởng bởi Tuổi bệnh nhân, thời gian hiếm muộn, loại phác đồ COS được chọn. Trong quá trình can thiệp, liều dược chất còn dựa vào BMI và tuổi bệnh nhân.

+ Kết cục sinh nở (Birth) thành công hay thất bại (sẩy thai) là hệ quả trực tiếp của việc thụ thai thành công (Preg) và thai kì diễn tiến, nó cũng phụ thuộc vào tuổi của người mẹ (Age), và những nguy cơ bệnh lý sản khoa có liên hệ đến tuổi và BMI.

+ Trước đó, ta có kết cục thụ thai lâm sàng/thai diễn tiến (Preg), là hệ quả trực tiếp của yếu tố phôi (Embryo), bao gồm phôi có được tạo thành hay không ? tuổi phôi ? phẩm chất của phôi, thỏa tiêu chí có thể chuyển được, phương pháp chuyển phôi và số phôi chuyển. Ngoài ra, khả năng thụ thai còn phụ thuộc vào Tuổi người mẹ, hiệu quả của phác đồ chuẩn bị nội mạc tử cung, độ dày nội mạc.

+ Yếu tố phôi là hệ quả trực tiếp của số noãn thu được (Ooc), kết quả thụ tinh Fert, loại phác đồ COS, ngoài ra còn phụ thuộc vào hormone LH;

+ Khả năng trưởng thành noãn, biểu hiện qua số noãn MII là hệ quả trực tiếp của số noãn thu được, liên hệ với phác đồ COS, các hormone sử dụng trong phác đồ chuẩn bị nội mạc, 

+ Khả năng thụ tinh phụ thuộc vào số noãn MII, loại phương pháp thụ tinh (Insermination: IVF hay ICSI)

+ Số noãn thu được (Ooc) là hệ quả của phác đồ COS, phương pháp chuẩn bị nội mạc, tuổi của bệnh nhân, dự trữ buồng trứng, nồng độ FSH và LH

+ Độ dày nội mạc phụ thuộc vào phương pháp chuẩn bị nội mạc (Letrozole...), có liên hệ với BMI, tuổi bệnh nhân.

+ LH và FSH có liên hệ với tuổi và BMI,

+ Phương pháp thụ tinh (Inserm) và phác đồ COS được xem là yếu tố can thiệp độc lập.

Ta có thể dựng sơ đồ DAG bằng thư viện daggity trong R và hiển thị nó như dưới đây

```{r,message = FALSE,warning=FALSE}
coord_dag <- list(x = c(Birth = 9,
                        FSH = 1.5,
                        LH = 3,
                        Inserm = 1,
                        MII = 3.5,
                        Age = 4,
                        BMI = 7,
                        Fert = 3.5,
                        Embryo = 5,
                        EndThck = 7,
                        Preg = 7,
                        Letroz = 6.5,
                        Infdt = 5.5,
                        Stim = 1,
                        Ooc = 2.5),
                  y = c(Birth = 2,
                        FSH = 7.5,
                        LH = 7.5,
                        Inserm = 2,
                        MII = 2.5,
                        Age = 9,
                        BMI = 8.5,
                        Fert = 1,
                        Embryo = 2,
                        EndThck = 4,
                        Preg = 2,
                        Letroz = 6,
                        Infdt = 8,
                        Stim = 5.5,
                        Ooc = 4
                        )
                        )


dag <- dagify(
      Birth ~ BMI + Preg + Age,
      Preg ~ EndThck  + Letroz + Embryo + Age,
      EndThck ~ Age + Letroz + BMI,
      Embryo ~ LH + Fert + Stim,
      Fert ~ MII + Inserm + LH,
      MII ~ Ooc + Stim + Letroz,
      Ooc ~ Letroz + FSH + LH + Stim + Age,
      Letroz ~ Infdt + Age + BMI + Stim,
      FSH ~ Age + BMI,
      LH ~ Age + BMI,
      BMI ~ Age,
      coords = coord_dag,
      exposure = "Letroz",
      outcome = "Birth"
      )

dag%>%tidy_dagitty()%>%
  mutate(colors = recode(factor(name),
                         Birth = 1,
                        FSH = 2,
                        LH = 2,
                        Inserm = 5,
                        MII = 3,
                        Age = 6,
                        BMI = 6,
                        Fert = 3,
                        Embryo = 3,
                        EndThck = 4,
                        Preg = 3,
                        Letroz = 5,
                        Infdt = 6,
                        Stim = 5,
                        Ooc = 4
                         ))%>%
  ggdag::ggdag(edge_type = "diagonal") + 
  geom_dag_point(aes(colour = factor(colors)),
                 show.legend = F) +
  geom_dag_text(text_size = 3, 
                color = "black") +
  scale_color_brewer(palette = "Spectral")+
  theme_dag()
```

## Xác định tập hợp biến cần hiệu chỉnh

```{r}
paths(dag)$paths[c(1:10)]
```

Theo kết quả tìm được, ta có thể hiệu chỉnh cho tập hợp 3 biến : Age, BMI và phác đồ COS (Stim)

```{r,message = FALSE,warning=FALSE}
ggdag_adjustment_set(dag, 
                     shadow = T,
                     node_size = 12, 
                     exposure = "Letroz",
                     outcome = "Birth",
                     text_size = 3) + 
  theme_dag()+
  scale_color_manual(values = c("#f54278","#cbcfd1"))+
  theme(legend.position = "bottom")

adjustmentSets(dag, "Letroz","Birth")
```

## Ước lượng bằng mô hình hồi quy logistic

Sau đây, ta sẽ lần lượt thực hiện phân tích thống kê bằng mô hình logistic trong 3 trường hợp: 

**Trường hợp hiệu chỉnh máy móc và quá đáng**

```{r}
fit1 <- glm(LBirth ~ Method + Age + BMI + COS + 
              FSH + LH + nOOC + Inserm + 
              nEmbryo + Stage + Transf + Thickness,
            data = df,
           family = binomial)

rd = avg_comparisons(fit1, 
                     variables = "Method",
                     newdata = df)%>%
  dplyr::select(-c(1,6))

rd%>%knitr::kable()

or = avg_comparisons(
  fit1,
  variables = "Method",
  transform_pre = "lnoravg",
  transform_post = "exp")%>%dplyr::select(-c(8:10))

or %>% knitr::kable(digits = 3)
```

**Khi không hiệu chỉnh gì cả**

```{r}
fit2 <- glm(LBirth ~ Method,
            data = df,
           family = binomial)

rd = avg_comparisons(fit2, 
                     variables = "Method",
                     newdata = df)%>%
  dplyr::select(-c(1,6))

rd%>%knitr::kable()

or = avg_comparisons(
  fit2,
  variables = "Method",
  transform_pre = "lnoravg",
  transform_post = "exp")%>%dplyr::select(-c(8:10))

or %>% knitr::kable(digits = 3)
```

**Khi hiệu chỉnh vừa đủ và chính xác**

```{r,message = FALSE,warning=FALSE}
# m.data <- match.data(m.out1)
fit3 <- glm(LBirth ~ Method + Age + COS + BMI,
           data = df,
           family = binomial)


rd = avg_comparisons(fit3, 
                     variables = "Method",
                     newdata = df)%>%
  dplyr::select(-c(1,6))

rd%>%knitr::kable()

or = avg_comparisons(
  fit3,
  variables = "Method",
  transform_pre = "lnoravg",
  transform_post = "exp")%>%dplyr::select(-c(8:10))

or %>% knitr::kable(digits = 3)
```

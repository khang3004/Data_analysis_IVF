# Khảo sát kết cục nhị phân: Hồi quy logistic


## Công cụ cần thiết cho quy trình

+ Thư viện dplyr trong hệ sinh thái tidyverse để thao tác dữ liệu và thống kê mô tả
+ Thư viện ggplot2, ggrides, tidybayes và ggdist để vẽ một số biểu đồ thống kê;
+ Thư viện patchwork để ghép nhiều biểu đồ ggplot2 với nhau.
+ Thư viện gamlss để dựng mô hình GLM với phân phối Binomial
+ Thư viện marginaleffects để ước tính OR, RR và suy diễn thống kê từ kết quả mô hình.

```{r, warning=FALSE, message=FALSE}
library(tidyverse)
library(ggridges)

library(gamlss)
library(marginaleffects)

library(tidybayes)
library(ggdist)
library(patchwork)
```

## Chuẩn bị dữ liệu 

```{r}
df = read.csv('PPOS_OP.csv', sep = ';', 
              dec = ',', 
              fileEncoding = 'UTF-8-BOM')%>%
  na.omit()

df$Protocol = factor(df$Protocol)

df%>%dplyr::sample_frac(0.3)%>%head()%>%
  knitr::kable(digits = 2)
```

## Phân tích mô tả

**a) Khảo sát tần suất thai diễn tiến (biến OP_cum)**
Đây là một biến số rời rạc và chỉ có thể có 3 giá trị: 0, 1 hoặc 2. Kết quả mô tả như sau:

```{r}
getmode <- function(v) {
   uniqv <- unique(v)
   uniqv[which.max(tabulate(match(v, uniqv)))]
}

df%>%group_by(Protocol)%>%
  summarize(n = n(),
            Sum = sum(OP_cum),
            mean = mean(OP_cum),
            Median = median(OP_cum),
            Mode = getmode(OP_cum),
            SD = sd(OP_cum),
            p5 = quantile(OP_cum, 0.05),
            p95 = quantile(OP_cum, 0.95),
            )%>%knitr::kable(digits = 3)
```

**b) Nếu xét về tỷ lệ thai diễn tiến trên tổng số phôi chuyển:**

```{r}
df%>%group_by(Protocol)%>%
  summarize(n = n(),
            Mean = mean(OP_rate),
            Median = median(OP_rate),
            SD = sd(OP_rate),
            p5 = quantile(OP_rate, 0.05),
            p95 = quantile(OP_rate, 0.95),
            )%>%knitr::kable(digits = 3)
```

**c) Tỷ số xác suất thành công/thất bại (Odds)**

Ta có thể ước lượng kết quả thai diễn tiến theo một cách khác, bằng tỷ số Odds

$$Odds = \frac{p_1}{p_0} = \frac{p_1}{(1 - p_1)}$$
Với $p_1$ là xác suất thành công, $p_0$ là xác suất thất bại.

```{r}
df%>%mutate(Odds = OP_rate/(1-OP_rate))->odd_df

odd_df$Odds[!is.finite(odd_df$Odds)] <- NA

odd_df%>%
  group_by(Protocol)%>%
  summarize(n = n(),
            Mean = mean(Odds, na.rm=TRUE),
            Median = median(Odds,na.rm=TRUE),
            SD = sd(Odds, na.rm=TRUE),
            p5 = quantile(Odds, 0.05, 
                          na.rm=TRUE),
            p95 = quantile(Odds, 
                           0.95,na.rm=TRUE),
            )%>%
  knitr::kable(digits = 3)
```

**d) Nếu xét giá trị thành công hay thất bại tuyệt đối (biến nhị giá OP_bin)**

```{r}
df%>%group_by(Protocol)%>%
  summarize(n = n(),
            Rate = mean(OP_bin),
            Freq = sum(OP_bin),
            Odds = Rate/(1-Rate),
            )%>%knitr::kable(digits = 3)
```

Ta lần lượt khảo sát trực quan 3 hình thức khảo sát kết quả thai diễn tiến trong 3 biểu đồ sau

```{r}
pals = c("#0faaf2","#f20f4f")

p1 = df %>% ggplot(aes(y = OP_cum, 
                  x = Protocol, 
                  fill= Protocol)) + 
  geom_jitter(aes(fill = Protocol),
              shape = 21,
              alpha = 0.8,
              width = 0.1,
              height = 0.2,
              show.legend = T)+
  labs(y="Cummulated OP", x = "Protocol") + 
  scale_fill_manual(values = pals, name = "Protocol") +
  scale_y_continuous(breaks = c(0,1,2,3))+
  theme_bw(10) +
  theme(axis.text = element_text(size = 10, color = "black"),
        axis.title = element_text(size = 10, color = "black"))

p2 = df %>% ggplot(aes(x = OP_rate, 
                  y = Protocol, 
                  fill= Protocol)) + 
  geom_density_ridges(aes(fill = Protocol),
                      stat = "binline",
                      scale = 0.5, 
                      bins = 30,
                      alpha = 0.8)+
  labs(x="Cummulated OP rate", y = "Protocol") + 
  scale_fill_manual(values = pals, name = "Protocol") +
  coord_flip()+
  theme_bw(10)

p3 = df%>%
  group_by(Protocol)%>%
  summarise(Success = mean(OP_bin),
            Failure = 1 - Success)%>%
  gather(c(2,3),key = "OP", value = "Rate")%>%
  ggplot(aes(x = Protocol, y = Rate))+
  geom_bar(aes(fill = OP), stat = "identity")+
  scale_fill_manual(values = c("#c0bec2","#f03a79"), 
                    name = "OP Outcome") +
  theme_bw(10)


p3 + p1/p2
```

```{r}
p4 = df%>%gather(c(1,3,6), 
            key = "Factor", 
            value = "value")%>%
  ggplot(aes(x = value, y = OP_bin))+
  geom_smooth(aes(fill = Protocol, 
                  col = Protocol),
              method = "glm", 
              method.args = list(family = "binomial"),
              show.legend = F)+
  scale_y_continuous(limits = c(0,1))+
  scale_fill_manual(values = pals, name = "Protocol") +
  scale_color_manual(values = pals, name = "Protocol") +
  facet_wrap(~Factor, ncol=1, scales = "free_x")+
  labs(y="Binary OP", x = NULL) + 
  theme_bw(10)

p5 = df%>%gather(c(1,3,6), 
            key = "Factor", 
            value = "value")%>%
  ggplot(aes(x = value, y = OP_rate))+
  geom_smooth(aes(fill = Protocol, 
                  col = Protocol),
              method = "glm", 
              method.args = list(family = "quasibinomial"))+
  scale_y_continuous(limits = c(0,1))+
  scale_fill_manual(values = pals, name = "Protocol") +
  scale_color_manual(values = pals, name = "Protocol") +
  facet_wrap(~Factor, ncol=1, scales = "free_x")+
  labs(y="OP rate", x = NULL) + 
  theme_bw(10)

p6 = df%>%mutate(odd = OP_rate/(1-OP_rate))%>%
  gather(c(1,3,6),
            key = "Factor", 
            value = "value")%>%
  ggplot(aes(x = value, y = odd))+
  geom_smooth(aes(fill = Protocol, 
                  col = Protocol),
              method = "glm",
              show.legend = F)+
  scale_fill_manual(values = pals, name = "Protocol") +
  scale_color_manual(values = pals, name = "Protocol") +
  facet_wrap(~Factor, ncol=1, scales = "free_x")+
  labs(y="Odds = p1/p0", x = NULL) + 
  theme_bw(10)
                
p4+p6+p5
```

Hình: đồ thị hàm logistic. Từ giá trị đầu vào là số thực $x$ bất kì, hàm logistic xuất kết quả là một giá trị trong khoảng (0,1). 

```{r,echo=F}
x = seq(-4,4,0.01)
y = 0.5 + 0.5*tanh(x)

qplot(x,y, 
      geom = "line", 
      color = "red", 
      show.legend = F)+
  labs(title = "logistic function: y = 1/(1 + exp(-x))",
      y = "y = 1/(1 + exp(-x)")+
  scale_x_continuous(breaks = seq(-4,4,1))+
  theme_bw()
```

Mối liên hệ nghịch đảo giữa 2 hàm logit và hàm logistic cổ điển: 

```{r, echo = F}
p = seq(0,1,0.01)
y = log(p/(1-p))

p1 = qplot(p,y, 
      geom = "line", 
      color = "red", 
      show.legend = F)+
  labs(title = "logit function: y=log(p/(1-p))", 
       y = "logit(p) = log(odds) = log(p/(1-p)")+
  theme_bw()

p2 = qplot(y,p, 
      geom = "line", 
      color = "red", 
      show.legend = F)+
  labs(title = "logistic function", 
       x = "logit(p)",
       y = "p")+
  theme_bw()

p1 + p2
```

## Mô hình hồi quy Logistic cho biến kết quả nhị giá

```{r}
log_mod = glm(OP_bin ~  Protocol*AFC + Thickness + Age,
                data = df,
                family = "binomial")

summary(log_mod)
```

Từ đây, ta có thể ước tính 3 loại marginal effects gồm:

**1) Marginal risk difference (RD)**

```{r}
rd = avg_comparisons(
  log_mod,
  variables = "Protocol")%>%
  dplyr::select(-c(1,2,5,6))%>%
  mutate(contrast = "RD")

rd %>% knitr::kable(digits = 3)
```

**2) Marginal Odds ratio (OR)**
**3) Marginal risk ratio (RR)**

Kết quả OR và RR được trình bày trong bảng sau:

```{r}
or = avg_comparisons(
  log_mod,
  variables = "Protocol",
  transform_pre = "lnoravg",
  transform_post = "exp")%>%
  dplyr::select(-c(1,2,8:10))%>%
  mutate(contrast = "OR")

rr = avg_comparisons(
  log_mod,
  variables = "Protocol",
  transform_pre = "lnratioavg",
  transform_post = exp)%>%dplyr::select(-c(1,2,8:10))%>%
   mutate(contrast = "RR")

rbind(or,rr) %>% knitr::kable(digits = 3)
```

Ta cũng có thể tính RD, OR và RR cho các biến định lượng

```{r}
rd = avg_comparisons(
  log_mod,
  variables = list(Age = 1,
                   AFC = 1, 
                   Thickness = 1),
  by = "Protocol")%>%
  dplyr::select(-c(1,7,11:13))%>%
  mutate(contrast = "RD")

rd %>% knitr::kable(digits = 3)

or = avg_comparisons(
  log_mod,
  variables = list(Age = 1,
                   AFC = 1, 
                   Thickness = 1),
  by = "Protocol",
  transform_pre = "lnoravg",
  transform_post = "exp")%>%
  dplyr::select(-c(1))%>%
  mutate(contrast = "OR")

rr = avg_comparisons(
  log_mod,
  variables = list(Age = 1,
                   AFC = 1, 
                   Thickness = 1),
  by = "Protocol",
  transform_pre = "lnratioavg",
  transform_post = exp)%>%
  dplyr::select(-c(1,9:11))%>%
   mutate(contrast = "RR")

rbind(or,rr) %>% knitr::kable(digits = 3)
```

Biểu đồ đối chiếu phân phối toàn thể của xác suất đạt thai diễn tiến cộng dồn trong 107 cá thể dùng phác đồ GnRHa và 99 cá thể dùng phác đồ PPOS.

```{r}
effs = comparisons(log_mod,
                   variables = "Protocol", 
                   newdata = datagrid(grid_type = 'counterfactual'))

effs %>% ggplot() +
  geom_density(aes(x = predicted, fill = Protocol), alpha = 0.5) +
  geom_vline(xintercept = mean(effs$predicted_lo), color = "blue", 
             linetype = 2, size = 1) +
  geom_vline(xintercept = mean(effs$predicted_hi), color = "red", 
             linetype = 2, size = 1) +
  labs(x = "Probability of OP", 
       title = "Unit level contrast",
       fill = "Protocol")+
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.1))+
  scale_fill_manual(values = pals)+
  theme_bw(10)
```

Một biểu đồ khác cho phép hình dung về cán cân chênh lệch của hiệu quả giữa 2 phác đồ, đến cấp độ từng cá thể.

```{r}
effs %>% ggplot(aes(x=predicted_lo, y=predicted_hi))+
  geom_abline(slope = 1, intercept = 0, linetype = 2) +
  geom_point(aes(x=predicted_lo, y=predicted_hi,
                 col = predicted_hi))+
  coord_fixed() +
  scale_x_continuous(limits = c(0,1))+
  scale_y_continuous(limits = c(0,1))+
  scale_color_viridis_c('OP prob')+
  labs(x = "Probability of OP by GnRH_ant", y = "Probability of OP by PPOS")+
  theme_bw()

```

Các biểu đồ tiếp theo trình bày về mối liên hệ giữa Tuổi, AFC và Thickness với xác suất thai diễn tiến, riêng cho mỗi nhóm phác đồ:

```{r}
preds = predictions(model = log_mod,
                    newdata = datagrid(Age = seq(20,40,5),
                                       Protocol = c("GnRHa","PPOS"),
                                       grid_type = "counterfactual"))

preds%>%ggplot(aes(x = Age,
                   y = estimate)) +
  stat_halfeye(alpha = 0.5, 
               .width = c(0.75, 0.95),
               point_interval = 'median_qi',
               show.legend = F)+
  stat_lineribbon(aes(y = estimate, fill = Protocol), 
                  .width = c(.95, .75, .50), 
                  alpha = 1/5,
                  show.legend = F) +
  labs(y="OP probability", x = "Age") + 
  scale_x_continuous(limits = c(20,45), breaks = seq(20,40,5))+
  scale_y_continuous(limits = c(0,1))+
  facet_wrap(~Protocol, ncol = 2)+
  theme_bw(10)+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  theme(axis.text = element_text(size = 10, color = "black"),
        axis.title = element_text(size = 10, color = "black"))

```

```{r}
preds = predictions(model = log_mod,
                    newdata = datagrid(AFC = seq(1,30,5),
                                       Protocol = c("GnRHa","PPOS"),
                                       grid_type = "counterfactual"))

preds%>%ggplot(aes(x = AFC,
                   y = estimate)) +
  stat_halfeye(alpha = 0.5, 
               .width = c(0.75, 0.95),
               point_interval = 'median_qi',
               show.legend = F)+
  stat_lineribbon(aes(y = estimate, fill = Protocol), 
                  .width = c(.95, .75, .50), 
                  alpha = 1/5,
                  show.legend = F) +
  labs(y="OP probability", x = "AFC") + 
  scale_x_continuous(limits = c(0,31), breaks = seq(0,30,5))+
  scale_y_continuous(limits = c(0,1))+
  facet_wrap(~Protocol, ncol = 2)+
  theme_bw(10)+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  theme(axis.text = element_text(size = 10, color = "black"),
        axis.title = element_text(size = 10, color = "black"))
```

```{r}
preds = predictions(model = log_mod,
                    newdata = datagrid(Thickness = seq(8,20,4),
                                       Protocol = c("GnRHa","PPOS"),
                                       grid_type = "counterfactual"))

preds%>%ggplot(aes(x = Thickness,
                   y = estimate)) +
  stat_halfeye(alpha = 0.5, 
               .width = c(0.75, 0.95),
               point_interval = 'median_qi',
               show.legend = F)+
  stat_lineribbon(aes(y = estimate, fill = Protocol), 
                  .width = c(.95, .75, .50), 
                  alpha = 1/5,
                  show.legend = F) +
  labs(y="OP probability", x = "Endometrial thickness") + 
  scale_x_continuous(limits = c(7,22), breaks =seq(8,20,4))+
  scale_y_continuous(limits = c(0,1))+
  facet_wrap(~Protocol, ncol = 2)+
  theme_bw(10)+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  theme(axis.text = element_text(size = 10, color = "black"),
        axis.title = element_text(size = 10, color = "black"))
```

## Mô hình hồi quy Binomial cho tỷ lệ OP/tổng số phôi

```{r}
bi_mod = gamlss(cbind(OP_cum, n_ET-OP_cum) ~ 
                  Protocol * AFC + Thickness + Age,
                data = df,
                family = BI(mu.link = "logit"))

summary(bi_mod)
```

```{r}
dr = avg_comparisons(
  bi_mod,
  what = "mu",
  variables = "Protocol")%>%
  dplyr::select(-c(1,2,5,6))%>%
  mutate(contrast = "DR")

or = avg_comparisons(
  bi_mod,
  what = "mu",
  variables = "Protocol",
  transform_pre = "lnoravg",
  transform_post = "exp")%>%
  dplyr::select(-c(1,2,8:10))%>%
  mutate(contrast = "OR")

rr = avg_comparisons(
  bi_mod,
  what = "mu",
  variables = "Protocol",
  transform_pre = "lnratioavg",
  transform_post = exp)%>%dplyr::select(-c(1,2,8:10))%>%
   mutate(contrast = "RR")

rbind(dr, or,rr) %>% knitr::kable(digits = 3)
```

Ta thực hiện mô tả phân phối toàn thể của hiệu ứng này qua hai biểu đồ sau:

```{r}
effs = comparisons(bi_mod,
                   what = "mu",
                   variables = "Protocol", 
                   newdata = datagrid(grid_type = 'counterfactual'))

effs %>% ggplot() +
  geom_density(aes(x = predicted, fill = Protocol), alpha = 0.5) +
  geom_vline(xintercept = mean(effs$predicted_lo), color = "blue", 
             linetype = 2, size = 1) +
  geom_vline(xintercept = mean(effs$predicted_hi), color = "red", 
             linetype = 2, size = 1) +
  labs(x = "Probability of OP", 
       title = "Unit level contrast",
       fill = "protocol")+
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,0.1))+
  scale_fill_manual(values = pals)+
  theme_bw(10)
```

```{r}
effs %>% ggplot(aes(x=predicted_lo, y=predicted_hi))+
  geom_abline(slope = 1, intercept = 0, linetype = 2) +
  geom_point(aes(x=predicted_lo, y=predicted_hi,
                 col = predicted_hi))+
  coord_fixed() +
  scale_x_continuous(limits = c(0,1))+
  scale_y_continuous(limits = c(0,1))+
  scale_color_viridis_c('OP prob')+
  labs(x = "Probability of OP by GnRH_ant", y = "Probability of OP by PPOS")+
  theme_bw()
```

Cuối cùng, ta cũng khảo sát về liên hệ giữa Tuổi, AFC và Thickness với tỷ lệ thai diễn tiến cộng dồn tùy theo phác đồ.

```{r}
preds = predictions(model = bi_mod,
                    what = "mu",
                    newdata = datagrid(Age = seq(20,40,5),
                                       Protocol = c("GnRHa","PPOS"),
                                       grid_type = "counterfactual"))

preds%>%ggplot(aes(x = Age,
                   y = estimate)) +
  stat_halfeye(alpha = 0.5, 
                    .width = c(0.75, 0.95),
                    point_interval = 'median_qi',
                    show.legend = F)+
  stat_lineribbon(aes(y = estimate, fill = Protocol), 
                  .width = c(.95, .75, .50), 
                  alpha = 1/5,
                  show.legend = F) +
  labs(y="OP probability", x = "Age") + 
  scale_x_continuous(limits = c(20,45), breaks = seq(20,40,5))+
  scale_y_continuous(limits = c(0,1))+
  facet_wrap(~Protocol, ncol = 2)+
  theme_bw(10)+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  theme(axis.text = element_text(size = 10, color = "black"),
        axis.title = element_text(size = 10, color = "black"))

```

```{r}
preds = predictions(model = bi_mod,
                    what = "mu",
                    newdata = datagrid(AFC = seq(1,30,5),
                                       Protocol = c("GnRHa","PPOS"),
                                       grid_type = "counterfactual"))

preds%>%ggplot(aes(x = AFC,
                   y = estimate)) +
  stat_halfeye(alpha = 0.5, 
               .width = c(0.75, 0.95),
               point_interval = 'median_qi',
               show.legend = F)+
  stat_lineribbon(aes(y = estimate, fill = Protocol), 
                  .width = c(.95, .75, .50), 
                  alpha = 1/5,
                  show.legend = F) +
  labs(y="OP probability", x = "AFC") + 
  scale_x_continuous(limits = c(0,31), breaks = seq(0,30,5))+
  scale_y_continuous(limits = c(0,1))+
  facet_wrap(~Protocol, ncol = 2)+
  theme_bw(10)+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  theme(axis.text = element_text(size = 10, color = "black"),
        axis.title = element_text(size = 10, color = "black"))

```

```{r}
preds = predictions(model = bi_mod,
                    what = "mu",
                    newdata = datagrid(Thickness = seq(8,20,4),
                                       Protocol = c("GnRHa","PPOS"),
                                       grid_type = "counterfactual"))

preds%>%ggplot(aes(x = Thickness,
                   y = estimate)) +
  stat_halfeye(alpha = 0.5, 
               .width = c(0.75, 0.95),
               point_interval = 'median_qi',
               show.legend = F)+
  stat_lineribbon(aes(y = estimate, fill = Protocol), 
                  .width = c(.95, .75, .50), 
                  alpha = 1/5,
                  show.legend = F) +
  labs(y="OP probabilitys", x = "Endometrial thickness") + 
  scale_x_continuous(limits = c(7,22), breaks =seq(8,20,4))+
  scale_y_continuous(limits = c(0,1))+
  facet_wrap(~Protocol, ncol = 2)+
  theme_bw(10)+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  theme(axis.text = element_text(size = 10, color = "black"),
        axis.title = element_text(size = 10, color = "black"))

```

# Mô tả dữ liệu đa biến: Phân tích nhân tố chính (PCA)

## Công cụ cần thiết

Quy trình cần những thư viện sau đây:
+ Hệ sinh thái tidyverse để thực hiện thao tác dữ liệu và đồ họa (dplyr và ggplot2)
+ Thư viện FactoMineR[@factorminer] và factoextra[@factoextra] cho phân tích PCA
+ Thư viện GGally[@ggally] để vẽ một ma trận biểu đồ tán xạ, mật độ phân phối và 2D density plot cho dữ liệu đa biến 
+ patchwork [@patchwork]: để thiết kế bố cục khi ghép nối nhiều biểu đồ ggplot

```{r}
library(tidyverse)
library(FactoMineR)
library(factoextra)
library(patchwork)
library(GGally)
```

```{r,message = FALSE,warning=FALSE}
df = read.csv('PCOS_IR.csv', 
              sep = ';', 
              dec = ',',
              fileEncoding = 'UTF-8-BOM')

df$Group = as.factor(df$Group)

df_num = df %>% dplyr::select(-1)

df_num%>%head(5)%>%knitr::kable()
```

```{r,cache =T}
pal_fill = c("IR" = '#fcba03', 
             "Norm" = '#aede12',
             "PCOS"='#fc0356')

plotfuncmid <- function(data,mapping){
  p <- ggplot(data = data,
              mapping=mapping)+
    geom_density(aes(fill=Group),
                 alpha=0.3,
                 color="black")+
    scale_fill_manual(values=pal_fill)
  p
}

plotfuncLow <- function(data,mapping){
  p <- ggplot(data = data,
              mapping=mapping)+
    stat_density2d(geom="polygon",
                   aes(fill=Group,
                       alpha = ..level..))+
    scale_fill_manual(values=pal_fill)+
    scale_color_manual(values=pal_fill)
  p
}

plotfuncUp <- function(data,mapping){
  p <- ggplot(data = data,
              mapping=mapping)+
    geom_point(aes(color=Group),
                       alpha = 0.3,
                    size = 0.01)+
    scale_color_manual(values=pal_fill)
  p
}

ggpairs(data = df,
        columns=c(2:16),
        lower = list(continuous=plotfuncLow),
        diag = list(continuous=plotfuncmid),
        upper = list(continuous=plotfuncUp),
        )+
  theme_bw(5)
```

```{r}
df.cov = cov(df_num)
df.eigen = eigen(df.cov)

n_feats = length(df.eigen$values)

PVE <- df.eigen$values / sum(df.eigen$values)

# PVE (aka scree) plot
PVEplot <- qplot(c(1:n_feats ), PVE) + 
  geom_line() + 
  scale_x_continuous(breaks = 
                       seq(1,n_feats))+
  ylim(0, 1)+
  labs(y = 'PVE', x = 'n Components')+
  ggtitle("Scree Plot")+
  theme_bw(8)

# Cumulative PVE plot
cumPVE <- qplot(c(1:n_feats), cumsum(PVE)) + 
  geom_line() + 
  scale_x_continuous(breaks = seq(1,n_feats))+
  ylim(0,1)+
  labs(x = 'n Components', y = 'Cumulative PVE')+
  ggtitle("Cumulative Scree Plot")+
  theme_bw(8)

PVEplot + cumPVE
```

## Phân tích PCA

```{r,message = FALSE,warning=FALSE}
res.pca <- PCA(df_num,
               ncp = 6,
               scale.unit = T,
               graph = F)

# summary(res.pca)
```

## Trình bày kết quả PCA bằng biểu đồ Biplot

```{r}
`-.gg` <- function(plot, layer) {
  if (missing(layer)) {
    stop("Cannot use `-.gg()` with a single argument. Did you accidentally put - on a new line?")
  }
  if (!is.ggplot(plot)) {
    stop('Need a plot on the left side')
  }
  plot$layers = c(layer, plot$layers)
  plot
}
```

3) Dựng biểu đồ biplot cơ bản bằng hàm fviz_pca_biplot

```{r}
title = '3 Clinical groups'

P = fviz_pca_biplot(res.pca,label="var",
                    geom = c("text"),
                    addEllipses=TRUE,
                    ellipse.level= 0.95,
                    col.var= "black",
                    title = title)+
  scale_fill_manual(values = pal_fill)
```

4) Lần lượt chèn thêm 1 lớp biểu đồ tán xạ bằng hàm geom_jitter và 1 lớp biểu đồ density 2 chiều bằng hàm stat_density2d; sau đó dùng phổ màu đã xác định.

```{r}
P - geom_jitter(shape=21,
                aes(fill= df$Group),
                color="black",
                alpha = 0.2,
                size=1.5,
                show.legend = F
)-
  stat_density2d(geom="polygon",
                 na.rm = T,
                 contour_var = "density",
                 aes(fill= df$Group,
                     alpha = ..level..), 
                 color = NA, 
                 show.legend = T)+
  scale_color_manual(values = pal_fill)+
  coord_fixed()
```

```{r}
d1=fviz_contrib(res.pca, 
                choice="var", 
                axes = 1,
                fill="#f53656",
                color="black")+
  labs(title = "Contributions to Dim 1", 
       x = 'Variables')+
  geom_text(aes(label=round(contrib,2)),
            nudge_y=1.5,
            color="red4")+
  coord_flip()+
  theme_bw(8)

d2=fviz_contrib(res.pca, 
                choice="var", 
                axes = 2,fill="#0fc9f2",color="black")+
  labs(title = "Contributions to Dim 2",
       y = 'PVE', 
       x = 'Variables')+
  geom_text(aes(label=round(contrib,2)),
            nudge_y=1.8,color="blue4")+
  coord_flip()+
  theme_bw(8)

d1 + d2
```

## Khảo sát đặc tính phân phối của mỗi thành phần chính

```{r}
res.pca$ind$coord %>% 
  as.tibble()%>%
  mutate(Group = df$Group) %>%
  gather(c(1:4), value = "Value", key = 'Components')%>%
  group_by(Components,Group)%>%
  summarise(n = n(),
            Mean = mean(Value),
            sd = sd(Value),
            Median = median(Value),
            p5 = quantile(Value, 0.05),
            p95 = quantile(Value, 0.95))%>%
  knitr::kable(digits = 2)
```
Kết quả này có thể trình bày trực quan bằng biểu đồ sau

```{r}
res.pca$ind$coord %>% 
  as.tibble()%>%
  mutate(Group = df$Group) %>%
  gather(c(1:4), value = "score", key = 'Components')%>%
  ggplot()+
  geom_density(aes(x = score, fill = Group), alpha = 0.5)+
  facet_wrap(~ Components, scales = "free")+
  scale_fill_manual(values = pal_fill)+
  theme_bw(8)+
  theme(legend.position="bottom")
```
